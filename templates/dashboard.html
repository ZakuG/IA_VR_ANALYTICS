<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lisis VR</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn-logout:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .stat-card .label {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .chart-card canvas {
            height: 350px !important;
            max-height: 350px;
        }

        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .students-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
        }

        .risk {
            color: #dc3545;
            font-weight: bold;
        }

        .good {
            color: #28a745;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        /* Modal para ver resultados por maqueta */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-modal {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            transition: transform 0.2s;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(85vh - 100px);
            overflow-y: auto;
        }

        .maqueta-selector {
            margin-bottom: 20px;
        }

        .maqueta-selector select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .maqueta-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .maqueta-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .maqueta-stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ebff 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .maqueta-stat-card h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .maqueta-stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .sessions-table {
            margin-top: 20px;
        }

        .sessions-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .sessions-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .sessions-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .sessions-table tr:hover {
            background: #f8f9ff;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ============================================ */
        /* SPINNER DE CARGA */
        /* ============================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
        }

        /* ============================================ */
        /* TOAST NOTIFICATIONS */
        /* ============================================ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            animation: slideIn 0.3s ease forwards;
        }

        .toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            to { transform: translateX(400px); }
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-message {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-progress {
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .toast-progress-bar {
            height: 100%;
            width: 100%;
            animation: progress 4s linear forwards;
        }

        @keyframes progress {
            to { width: 0%; }
        }

        .toast.success { border-left: 4px solid #28a745; }
        .toast.success .toast-progress-bar { background: #28a745; }
        
        .toast.error { border-left: 4px solid #dc3545; }
        .toast.error .toast-progress-bar { background: #dc3545; }
        
        .toast.warning { border-left: 4px solid #ffc107; }
        .toast.warning .toast-progress-bar { background: #ffc107; }
        
        .toast.info { border-left: 4px solid #17a2b8; }
        .toast.info .toast-progress-bar { background: #17a2b8; }

        /* ============================================ */
        /* MODAL DE CONFIRMACI√ìN */
        /* ============================================ */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirm-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            transform: scale(0.7);
            transition: transform 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .confirm-modal.active .confirm-modal-content {
            transform: scale(1);
        }

        .confirm-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .confirm-modal-icon {
            font-size: 48px;
        }

        .confirm-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .confirm-modal-message {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-confirm {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm.danger {
            background: #dc3545;
            color: white;
        }

        .btn-confirm.danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-confirm.primary {
            background: #667eea;
            color: white;
        }

        .btn-confirm.primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* ============================================ */
        /* TRANSICIONES SUAVES */
        /* ============================================ */
        .stat-card, .chart-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover, .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .btn {
            transition: all 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text">Cargando datos...</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <div class="confirm-modal-icon" id="confirmIcon">‚ö†Ô∏è</div>
                <div class="confirm-modal-title" id="confirmTitle">Confirmaci√≥n</div>
            </div>
            <div class="confirm-modal-message" id="confirmMessage"></div>
            <div class="confirm-modal-buttons">
                <button class="btn-cancel" onclick="hideConfirmModal()">Cancelar</button>
                <button class="btn-confirm" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Dashboard de An√°lisis VR</h1>
                <p>Bienvenido, {{ profesor.nombre }}</p>
            </div>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="refreshData()">üîÑ Actualizar Datos</button>
                <button class="btn btn-primary" onclick="verResultadosPorMaqueta()">üìä Ver por Maqueta</button>
                <a href="/dashboard/manual-entry" class="btn btn-secondary">üìù Registro Manual</a>
                <button class="btn btn-logout" onclick="confirmLogout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="loading" class="loading">Cargando datos...</div>

        <div id="content" style="display: none;">
            <!-- Insights Autom√°ticos -->
            <div id="insights-container" style="margin-bottom: 20px;"></div>

            <!-- Estad√≠sticas Generales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>TOTAL SESIONES</h3>
                    <div class="value" id="total-sesiones">0</div>
                    <div class="label">Total de intentos realizados</div>
                </div>
                <div class="stat-card">
                    <h3>PROMEDIO PUNTAJE</h3>
                    <div class="value" id="promedio-puntaje">0</div>
                    <div class="label">sobre 7 puntos</div>
                </div>
                <div class="stat-card">
                    <h3>TASA DE APROBACI√ìN</h3>
                    <div class="value" id="tasa-aprobacion">0%</div>
                    <div class="label">estudiantes con ‚â• 3 pts</div>
                </div>
                <div class="stat-card">
                    <h3>TIEMPO PROMEDIO</h3>
                    <div class="value" id="tiempo-promedio">0</div>
                    <div class="label">minutos</div>
                </div>
                <div class="stat-card">
                    <h3>TOTAL ESTUDIANTES</h3>
                    <div class="value" id="total-estudiantes">0</div>
                    <div class="label">en el sistema</div>
                </div>
                <div class="stat-card">
                    <h3>DESVIACI√ìN EST√ÅNDAR</h3>
                    <div class="value" id="desviacion-puntaje">0</div>
                    <div class="label">variabilidad de puntajes</div>
                </div>
            </div>

            <!-- An√°lisis de Correlaciones y Predicci√≥n -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìä An√°lisis de Correlaciones</h3>
                    <div id="correlation-content"></div>
                </div>
                <div class="chart-card">
                    <h3>üîÆ Modelo Predictivo</h3>
                    <div id="prediction-content"></div>
                </div>
            </div>

            <!-- Gr√°ficos Principales -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Distribuci√≥n de Puntajes</h3>
                    <canvas id="scoresChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Rendimiento por Maqueta</h3>
                    <canvas id="maquetasChart"></canvas>
                </div>
            </div>

            <!-- M√°s Gr√°ficos -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Relaci√≥n Tiempo vs Puntaje</h3>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Tendencia Temporal</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Clustering de Estudiantes -->
            <div class="chart-card" style="margin-bottom: 20px;">
                <h3>üë• Agrupaci√≥n de Estudiantes (Machine Learning)</h3>
                <div id="clustering-content"></div>
            </div>

            <!-- NUEVOS M√ìDULOS ML PROFESIONALES -->
            <!-- Clasificaci√≥n Binaria -->
            <div class="chart-card" style="margin-bottom: 20px;">
                <h3>ü§ñ Predicci√≥n de Aprobaci√≥n (Machine Learning)</h3>
                <div id="ml-clasificacion"></div>
            </div>

            <!-- K-Means Profesional -->
            <div class="chart-card" style="margin-bottom: 20px;">
                <h3>üìä An√°lisis de Clusters Profesional</h3>
                <div id="ml-clustering"></div>
            </div>

            <!-- Correlaciones con P-Values -->
            <div class="chart-card" style="margin-bottom: 20px;">
                <h3>üî¨ Correlaciones Estad√≠sticas Avanzadas</h3>
                <div id="ml-correlaciones"></div>
            </div>

            <!-- Estudiantes en Riesgo -->
            <div class="students-table">
                <h3>Estudiantes que Requieren Atenci√≥n</h3>
                <table id="risk-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Promedio</th>
                            <th>Tiempo Promedio (s)</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="risk-tbody"></tbody>
                </table>
            </div>

            <!-- Top Estudiantes -->
            <div class="students-table" style="margin-top: 20px;">
                <h3>Top 10 Estudiantes</h3>
                <table id="ranking-table">
                    <thead>
                        <tr>
                            <th>Posici√≥n</th>
                            <th>Estudiante</th>
                            <th>Promedio</th>
                            <th>Tiempo Promedio (s)</th>
                            <th>Puntuaci√≥n Final</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FUNCIONES UX/UI PROFESIONALES
        // ============================================
        
        // Spinner de Carga
        function showLoading(message = 'Cargando datos...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.spinner-text');
            text.textContent = message;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        // Sistema de Toast Notifications
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                    <div class="toast-progress">
                        <div class="toast-progress-bar"></div>
                    </div>
                </div>
            `;

            container.appendChild(toast);

            // Auto-dismiss
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Modal de Confirmaci√≥n
        let confirmCallback = null;

        function showConfirm(message, title = 'Confirmaci√≥n', icon = '‚ö†Ô∏è', confirmText = 'Confirmar', confirmClass = 'primary') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const iconEl = document.getElementById('confirmIcon');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmButton');

                titleEl.textContent = title;
                iconEl.textContent = icon;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `btn-confirm ${confirmClass}`;

                confirmCallback = () => {
                    resolve(true);
                    hideConfirmModal();
                };

                confirmBtn.onclick = confirmCallback;
                modal.classList.add('active');

                // Resolve false si se cierra sin confirmar
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        resolve(false);
                        hideConfirmModal();
                    }
                };
            });
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            confirmCallback = null;
        }

        // Logout con confirmaci√≥n
        async function confirmLogout() {
            const confirmed = await showConfirm(
                '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                'Cerrar Sesi√≥n',
                'üö™',
                'Cerrar Sesi√≥n',
                'danger'
            );

            if (confirmed) {
                logout();
            }
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        let scoresChart, maquetasChart, scatterChart, trendChart;

        async function refreshData() {
            showLoading('Actualizando datos...');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';

            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();

                if (response.ok) {
                    // Verificar si hay datos
                    if (data.message && data.message.includes('No hay datos')) {
                        hideLoading();
                        document.getElementById('loading').innerHTML = `
                            <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; color: #333;">
                                <h2 style="color: #667eea;">üìä Bienvenido al Dashboard</h2>
                                <p style="margin: 20px 0;">A√∫n no hay datos para analizar.</p>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-top: 20px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px;">Para comenzar:</h3>
                                    <ol style="text-align: left; display: inline-block;">
                                        <li style="margin: 10px 0;">Genera datos de prueba ejecutando: <code style="background: #e9ecef; padding: 5px 10px; border-radius: 3px;">python generate_test_data.py</code></li>
                                        <li style="margin: 10px 0;">O ingresa manualmente los datos</li>
                                        <li style="margin: 10px 0;">Luego recarga esta p√°gina</li>
                                    </ol>
                                </div>
                                <button onclick="refreshData()" class="btn btn-primary" style="margin-top: 20px;">Recargar Datos</button>
                            </div>
                        `;
                    } else {
                        updateDashboard(data);
                        hideLoading();
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('content').style.display = 'block';
                        showToast('Datos actualizados correctamente', 'success');
                    }
                } else {
                    hideLoading();
                    document.getElementById('loading').innerHTML = `
                        <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; color: #333;">
                            <h2 style="color: #dc3545;">‚ö†Ô∏è Error</h2>
                            <p>No se pudieron cargar los datos. ${data.message || 'Error desconocido'}</p>
                            <button onclick="refreshData()" class="btn btn-primary" style="margin-top: 20px;">Reintentar</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; color: #333;">
                        <h2 style="color: #dc3545;">‚ö†Ô∏è Error de Conexi√≥n</h2>
                        <p>No se pudo conectar con el servidor.</p>
                        <p style="color: #666; font-size: 14px;">${error.message}</p>
                        <button onclick="refreshData()" class="btn btn-primary" style="margin-top: 20px;">Reintentar</button>
                    </div>
                `;
            }
        }

        function updateDashboard(data) {
            // Verificar que existan datos
            if (!data.estadisticas || !data.estadisticas.general) {
                console.error('Datos incompletos recibidos');
                return;
            }
            
            // Actualizar estad√≠sticas generales
            const stats = data.estadisticas.general;
            document.getElementById('total-sesiones').textContent = stats.total_sesiones || 0;
            document.getElementById('total-estudiantes').textContent = stats.total_estudiantes || 0;
            document.getElementById('promedio-puntaje').textContent = stats.promedio_puntaje || 0;
            document.getElementById('tasa-aprobacion').textContent = (stats.tasa_aprobacion || 0) + '%';
            document.getElementById('tiempo-promedio').textContent = stats.promedio_tiempo_min ? stats.promedio_tiempo_min.toFixed(2) : '0.00';
            document.getElementById('desviacion-puntaje').textContent = stats.desviacion_puntaje || 0;

            // Mostrar insights
            displayInsights(data.insights);

            // Correlaciones
            displayCorrelations(data.correlaciones);

            // Predicci√≥n
            displayPrediction(data.prediccion);

            // Clustering
            displayClustering(data.clustering);

            // NUEVOS M√ìDULOS ML PROFESIONALES
            displayMLClasificacion(data.ml_clasificacion);
            displayMLClustering(data.ml_clustering);
            displayMLCorrelaciones(data.ml_correlaciones);

            // Actualizar gr√°ficos
            updateCharts(data);

            // Estudiantes en riesgo
            updateRiskTable(data.estudiantes_riesgo);

            // Ranking
            updateRankingTable(data.ranking);
        }

        function displayInsights(insights) {
            const container = document.getElementById('insights-container');
            container.innerHTML = '';

            if (!insights || insights.length === 0) return;

            insights.forEach(insight => {
                const alertClass = insight.tipo === 'critico' ? 'background: #f8d7da; border-color: #dc3545;' :
                                 insight.tipo === 'atencion' ? 'background: #fff3cd; border-color: #ffc107;' :
                                 insight.tipo === 'positivo' ? 'background: #d4edda; border-color: #28a745;' :
                                 'background: #d1ecf1; border-color: #17a2b8;';
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert';
                alertDiv.style = alertClass;
                alertDiv.innerHTML = insight.mensaje;
                container.appendChild(alertDiv);
            });
        }

        function displayCorrelations(corr) {
            const content = document.getElementById('correlation-content');
            
            if (!corr) {
                content.innerHTML = '<p>No hay suficientes datos</p>';
                return;
            }

            const tiempoStatus = corr.tiempo_puntaje.significativo ? '‚úÖ Significativa' : '‚ö†Ô∏è No significativa';
            const iaStatus = corr.ia_puntaje.significativo ? '‚úÖ Significativa' : '‚ö†Ô∏è No significativa';

            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Tiempo vs Puntaje:</strong><br>
                    Correlaci√≥n: <span style="font-size: 20px; font-weight: bold;">${corr.tiempo_puntaje.correlacion}</span><br>
                    ${tiempoStatus} (p=${corr.tiempo_puntaje.p_value})<br>
                    <em>${corr.tiempo_puntaje.interpretacion} - Fuerza ${corr.tiempo_puntaje.fuerza}</em>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>IA vs Puntaje:</strong><br>
                    Correlaci√≥n: <span style="font-size: 20px; font-weight: bold;">${corr.ia_puntaje.correlacion}</span><br>
                    ${iaStatus} (p=${corr.ia_puntaje.p_value})<br>
                    <em>${corr.ia_puntaje.interpretacion} - Fuerza ${corr.ia_puntaje.fuerza}</em>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <strong>Recomendaciones:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        ${corr.recomendaciones.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function displayPrediction(pred) {
            const content = document.getElementById('prediction-content');
            
            if (!pred || !pred.r2_score) {
                content.innerHTML = '<p>No hay suficientes datos para predicci√≥n</p>';
                return;
            }

            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Precisi√≥n del Modelo:</strong><br>
                    <span style="font-size: 24px; font-weight: bold; color: ${pred.r2_score > 0.7 ? '#28a745' : pred.r2_score > 0.4 ? '#ffc107' : '#dc3545'};">
                        ${(pred.r2_score * 100).toFixed(1)}%
                    </span> (${pred.precision})
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                    ${pred.formula}
                </div>
                <div style="margin-top: 10px;">
                    <em>${pred.interpretacion}</em>
                </div>
            `;
        }

        function displayClustering(clusters) {
            const content = document.getElementById('clustering-content');
            
            if (!clusters || Object.keys(clusters).length === 0) {
                content.innerHTML = '<p>No hay suficientes datos para clustering</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            for (const [key, cluster] of Object.entries(clusters)) {
                const color = cluster.nombre.includes('Destacados') ? '#28a745' :
                             cluster.nombre.includes('Riesgo') ? '#dc3545' :
                             cluster.nombre.includes('Eficientes') ? '#17a2b8' : '#ffc107';
                
                html += `
                    <div style="background: ${color}15; border-left: 4px solid ${color}; padding: 15px; border-radius: 5px;">
                        <h4 style="color: ${color}; margin-bottom: 10px;">${cluster.nombre}</h4>
                        <p><strong>Estudiantes:</strong> ${cluster.cantidad}</p>
                        <p><strong>Puntaje promedio:</strong> ${cluster.promedio_puntaje}</p>
                        <p><strong>Tiempo promedio:</strong> ${cluster.promedio_tiempo_min.toFixed(2)} min</p>
                        <p><strong>Uso de IA:</strong> ${cluster.promedio_ia.toFixed(1)} interacciones</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: ${color};">Ver estudiantes</summary>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${cluster.estudiantes.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        // ============================================
        // FUNCIONES ML PROFESIONALES
        // ============================================
        
        function displayMLClasificacion(ml_data) {
            const container = document.getElementById('ml-clasificacion');
            
            if (!ml_data || !ml_data.modelo_disponible) {
                container.innerHTML = `
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <p style="color: #666;">${ml_data?.mensaje || 'Modelo de clasificaci√≥n no disponible'}</p>
                    </div>
                `;
                return;
            }
            
            const mejor_accuracy = (ml_data.mejor_accuracy * 100).toFixed(1);
            const color_accuracy = ml_data.mejor_accuracy > 0.7 ? '#28a745' : ml_data.mejor_accuracy > 0.5 ? '#ffc107' : '#dc3545';
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Precisi√≥n del Modelo</div>
                        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">${mejor_accuracy}%</div>
                        <div style="font-size: 12px;">${ml_data.mejor_modelo}</div>
                    </div>
                    
                    <div style="background: #28a745; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Tasa de Aprobaci√≥n</div>
                        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">${ml_data.tasa_aprobacion_real.toFixed(1)}%</div>
                        <div style="font-size: 12px;">${ml_data.aprobados} de ${ml_data.total_sesiones} sesiones</div>
                    </div>
                    
                    <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Aprobados</div>
                        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">${ml_data.aprobados}</div>
                        <div style="font-size: 12px;">‚úÖ Puntaje ‚â• 3</div>
                    </div>
                    
                    <div style="background: #dc3545; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Reprobados</div>
                        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">${ml_data.reprobados}</div>
                        <div style="font-size: 12px;">‚ùå Puntaje < 3</div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìà Importancia de Caracter√≠sticas (Random Forest)</h4>
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>‚è±Ô∏è Tiempo (minutos)</span>
                            <span><strong>${(ml_data.random_forest.feature_importance.tiempo_minutos * 100).toFixed(1)}%</strong></span>
                        </div>
                        <div style="background: #e9ecef; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 25px; width: ${ml_data.random_forest.feature_importance.tiempo_minutos * 100}%;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ü§ñ Interacciones con IA</span>
                            <span><strong>${(ml_data.random_forest.feature_importance.interacciones_ia * 100).toFixed(1)}%</strong></span>
                        </div>
                        <div style="background: #e9ecef; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #f093fb, #f5576c); height: 25px; width: ${ml_data.random_forest.feature_importance.interacciones_ia * 100}%;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° Interpretaci√≥n del Modelo</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
            `;
            
            ml_data.interpretacion.forEach(item => {
                html += `<li style="margin-bottom: 8px;">${item}</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function displayMLClustering(ml_clustering) {
            const container = document.getElementById('ml-clustering');
            
            if (!ml_clustering || !ml_clustering.clusters || Object.keys(ml_clustering.clusters).length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <p style="color: #666;">No hay suficientes datos para clustering profesional</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #666;">Total de Estudiantes:</span>
                            <strong style="font-size: 20px; color: #667eea; margin-left: 10px;">${ml_clustering.total_estudiantes}</strong>
                        </div>
                        <div>
                            <span style="color: #666;">Clusters Identificados:</span>
                            <strong style="font-size: 20px; color: #667eea; margin-left: 10px;">${ml_clustering.n_clusters}</strong>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
            `;
            
            for (const [nombre, cluster] of Object.entries(ml_clustering.clusters)) {
                html += `
                    <div style="background: ${cluster.color}15; border: 2px solid ${cluster.color}; border-radius: 10px; padding: 20px; transition: transform 0.2s;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 32px; margin-right: 10px;">${cluster.icono}</span>
                            <div>
                                <h4 style="margin: 0; color: ${cluster.color};">${nombre}</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${cluster.nivel}</p>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                <div>
                                    <div style="color: #666;">Estudiantes:</div>
                                    <div style="font-weight: bold; font-size: 18px; color: ${cluster.color};">${cluster.total_estudiantes}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Promedio:</div>
                                    <div style="font-weight: bold; font-size: 18px; color: ${cluster.color};">${cluster.promedio_puntaje} / 7.0</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Tiempo:</div>
                                    <div style="font-weight: bold; color: #333;">${cluster.promedio_tiempo_min.toFixed(1)} min</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Uso IA:</div>
                                    <div style="font-weight: bold; color: #333;">${cluster.promedio_uso_ia.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: ${cluster.color}10; padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Caracter√≠sticas:</div>
                            ${cluster.caracteristicas.map(c => `
                                <span style="display: inline-block; background: white; padding: 4px 8px; border-radius: 3px; margin: 2px; font-size: 11px; color: ${cluster.color}; border: 1px solid ${cluster.color};">
                                    ${c}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `
                </div>
                
                <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; border-radius: 5px;">
                    <h4 style="color: #1976D2; margin-bottom: 10px;">üéØ Insights del Clustering</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #1976D2;">
            `;
            
            ml_clustering.interpretacion.forEach(item => {
                html += `<li style="margin-bottom: 8px;">${item}</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function displayMLCorrelaciones(ml_corr) {
            const container = document.getElementById('ml-correlaciones');
            
            if (!ml_corr || !ml_corr.disponible) {
                container.innerHTML = `
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <p style="color: #666;">${ml_corr?.mensaje || 'An√°lisis de correlaciones no disponible'}</p>
                    </div>
                `;
                return;
            }
            
            const corrs = ml_corr.correlaciones;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            `;
            
            for (const [nombre, datos] of Object.entries(corrs)) {
                const color = datos.significativo ? (datos.correlacion > 0 ? '#28a745' : '#dc3545') : '#6c757d';
                const fuerza_color = datos.fuerza === 'Fuerte' ? '#dc3545' : datos.fuerza === 'Moderada' ? '#ffc107' : '#17a2b8';
                
                html += `
                    <div style="background: ${color}10; border: 2px solid ${color}; border-radius: 10px; padding: 20px;">
                        <h4 style="color: ${color}; margin-bottom: 15px; text-transform: capitalize;">
                            ${nombre.replace('_', ' ‚Üí ')}
                        </h4>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <div style="font-size: 12px; color: #666;">Coeficiente de Correlaci√≥n</div>
                                <div style="font-size: 36px; font-weight: bold; color: ${color};">
                                    ${datos.correlacion.toFixed(3)}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; border-top: 1px solid #eee; padding-top: 10px;">
                                <div>
                                    <div style="color: #666;">P-Value:</div>
                                    <div style="font-weight: bold; color: #333;">${datos.p_value.toFixed(4)}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Fuerza:</div>
                                    <div style="font-weight: bold; color: ${fuerza_color};">${datos.fuerza}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 10px; background: ${datos.significativo ? '#d4edda' : '#f8d7da'}; border-radius: 5px; text-align: center;">
                            <span style="font-size: 12px; color: ${datos.significativo ? '#155724' : '#721c24'};">
                                ${datos.significativo ? '‚úÖ Significativo (p < 0.05)' : '‚ùå No significativo (p ‚â• 0.05)'}
                            </span>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px; color: #495057;">
                            ${datos.interpretacion}
                        </div>
                    </div>
                `;
            }
            
            html += `
                </div>
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üìä Resumen Estad√≠stico</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
            `;
            
            ml_corr.resumen.forEach(item => {
                html += `<li style="margin-bottom: 8px;">${item}</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateCharts(data) {
            const viz = data.visualizacion;
            
            // Gr√°fico de distribuci√≥n de puntajes
            const ctx1 = document.getElementById('scoresChart').getContext('2d');
            if (scoresChart) scoresChart.destroy();
            
            const labels = Object.keys(viz.distribucion_puntajes).map(k => `Puntaje ${k}`);
            const values = Object.values(viz.distribucion_puntajes);

            scoresChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad de Estudiantes',
                        data: values,
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(40, 167, 69, 0.9)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Gr√°fico por maqueta
            const ctx2 = document.getElementById('maquetasChart').getContext('2d');
            if (maquetasChart) maquetasChart.destroy();

            const maquetas = Object.keys(viz.puntajes_por_maqueta);
            const puntajes_maqueta = Object.values(viz.puntajes_por_maqueta);

            maquetasChart = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: maquetas,
                    datasets: [{
                        label: 'Promedio de Puntaje',
                        data: puntajes_maqueta,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 7,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Scatter plot Tiempo vs Puntaje
            const ctx3 = document.getElementById('scatterChart').getContext('2d');
            if (scatterChart) scatterChart.destroy();

            const scatterData = viz.scatter_tiempo_puntaje;
            const datasets = {};
            
            // Agrupar por maqueta
            scatterData.tiempo.forEach((t, i) => {
                const maqueta = scatterData.maqueta[i];
                if (!datasets[maqueta]) {
                    datasets[maqueta] = {
                        label: maqueta,
                        data: [],
                        backgroundColor: maqueta.includes('Motor') ? 'rgba(255, 99, 132, 0.6)' : 'rgba(54, 162, 235, 0.6)'
                    };
                }
                datasets[maqueta].data.push({ x: t, y: scatterData.puntaje[i] });
            });

            scatterChart = new Chart(ctx3, {
                type: 'scatter',
                data: {
                    datasets: Object.values(datasets)
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Tiempo (minutos)' },
                            beginAtZero: true
                        },
                        y: {
                            title: { display: true, text: 'Puntaje' },
                            beginAtZero: true,
                            max: 7,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Tendencia temporal
            const ctx4 = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: viz.tendencia_temporal.fechas,
                    datasets: [{
                        label: 'Puntaje Promedio',
                        data: viz.tendencia_temporal.puntajes,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 7,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function updateRiskTable(students) {
            const tbody = document.getElementById('risk-tbody');
            tbody.innerHTML = '';

            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #28a745;">‚úÖ No hay estudiantes en riesgo</td></tr>';
                return;
            }

            students.forEach(student => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${student.estudiante_nombre}</td>
                    <td class="risk">${student.puntaje_mean ? student.puntaje_mean.toFixed(2) : 'N/A'}</td>
                    <td>${student.tiempo_mean ? student.tiempo_mean.toFixed(2) : 'N/A'} min</td>
                    <td class="risk">‚ö†Ô∏è ${student.motivo_riesgo || 'Requiere atenci√≥n'}</td>
                `;
            });
        }

        function updateRankingTable(ranking) {
            const tbody = document.getElementById('ranking-tbody');
            tbody.innerHTML = '';

            if (!ranking || ranking.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay datos de ranking</td></tr>';
                return;
            }

            ranking.forEach((student, index) => {
                const row = tbody.insertRow();
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                row.innerHTML = `
                    <td>${medal} ${index + 1}</td>
                    <td>${student.estudiante_nombre}</td>
                    <td class="good">${student.puntaje.toFixed(2)}</td>
                    <td>${student.tiempo_minutos.toFixed(2)} min</td>
                    <td class="good">${student.puntuacion_final.toFixed(2)}</td>
                `;
            });
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            window.location.href = '/logout';
        }

        // Funci√≥n para ver resultados por maqueta
        let maquetasDisponibles = [];
        let todasSesiones = [];

        async function verResultadosPorMaqueta() {
            showLoading('Cargando maquetas...');
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();
                
                if (!data.estadisticas || !data.estadisticas.general || data.estadisticas.general.total_sesiones === 0) {
                    hideLoading();
                    showToast('No hay datos disponibles para mostrar', 'warning');
                    return;
                }

                // Obtener todas las sesiones
                const sesionesResponse = await fetch('/api/sesiones-todas');
                const sesionesData = await sesionesResponse.json();
                todasSesiones = sesionesData.sesiones || [];

                // Obtener maquetas √∫nicas
                maquetasDisponibles = [...new Set(todasSesiones.map(s => s.maqueta))];

                // Mostrar modal
                document.getElementById('maquetaModal').style.display = 'block';
                
                // Llenar selector de maquetas
                const select = document.getElementById('maquetaSelect');
                select.innerHTML = '<option value="">Selecciona una maqueta...</option>';
                maquetasDisponibles.forEach(maqueta => {
                    const option = document.createElement('option');
                    option.value = maqueta;
                    option.textContent = maqueta;
                    select.appendChild(option);
                });

                hideLoading();

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showToast('Error al cargar datos de maquetas', 'error');
            }
        }

        function cerrarModalMaqueta() {
            document.getElementById('maquetaModal').style.display = 'none';
        }

        function filtrarPorMaqueta() {
            showLoading('Filtrando datos...');
            const maquetaSeleccionada = document.getElementById('maquetaSelect').value;
            
            if (!maquetaSeleccionada) {
                hideLoading();
                document.getElementById('maquetaResultados').innerHTML = '<div class="no-data">Por favor selecciona una maqueta</div>';
                return;
            }

            // Filtrar sesiones por maqueta
            const sesionesFiltradas = todasSesiones.filter(s => s.maqueta === maquetaSeleccionada);

            if (sesionesFiltradas.length === 0) {
                document.getElementById('maquetaResultados').innerHTML = '<div class="no-data">No hay sesiones para esta maqueta</div>';
                return;
            }

            // Calcular estad√≠sticas
            const totalSesiones = sesionesFiltradas.length;
            const puntajes = sesionesFiltradas.map(s => s.puntaje);
            const tiempos = sesionesFiltradas.map(s => s.tiempo_segundos / 60); // en minutos
            
            const promedioPuntaje = (puntajes.reduce((a, b) => a + b, 0) / totalSesiones).toFixed(2);
            const promedioTiempo = (tiempos.reduce((a, b) => a + b, 0) / totalSesiones).toFixed(2);
            const mejorPuntaje = Math.max(...puntajes).toFixed(2);
            const peorPuntaje = Math.min(...puntajes).toFixed(2);

            // Estudiantes √∫nicos
            const estudiantesUnicos = [...new Set(sesionesFiltradas.map(s => s.estudiante_nombre))].length;

            // Generar HTML
            let html = `
                <div class="maqueta-stats">
                    <div class="maqueta-stat-card">
                        <h4>TOTAL SESIONES</h4>
                        <div class="value">${totalSesiones}</div>
                    </div>
                    <div class="maqueta-stat-card">
                        <h4>ESTUDIANTES</h4>
                        <div class="value">${estudiantesUnicos}</div>
                    </div>
                    <div class="maqueta-stat-card">
                        <h4>PROMEDIO PUNTAJE</h4>
                        <div class="value">${promedioPuntaje}</div>
                    </div>
                    <div class="maqueta-stat-card">
                        <h4>MEJOR PUNTAJE</h4>
                        <div class="value">${mejorPuntaje}</div>
                    </div>
                    <div class="maqueta-stat-card">
                        <h4>PEOR PUNTAJE</h4>
                        <div class="value">${peorPuntaje}</div>
                    </div>
                    <div class="maqueta-stat-card">
                        <h4>TIEMPO PROMEDIO</h4>
                        <div class="value">${promedioTiempo} min</div>
                    </div>
                </div>

                <div class="sessions-table">
                    <h3>üìã Detalle de Sesiones</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Estudiante</th>
                                <th>Puntaje</th>
                                <th>Tiempo</th>
                                <th>IA Usada</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sesionesFiltradas.forEach(sesion => {
                const fecha = new Date(sesion.fecha).toLocaleDateString('es-ES');
                const tiempo = (sesion.tiempo_segundos / 60).toFixed(2);
                const puntajeClass = sesion.puntaje >= 3 ? 'good' : 'risk';
                
                html += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${sesion.estudiante_nombre}</td>
                        <td class="${puntajeClass}">${sesion.puntaje.toFixed(2)}</td>
                        <td>${tiempo} min</td>
                        <td>${sesion.interacciones_ia} veces</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('maquetaResultados').innerHTML = html;
            hideLoading();
        }

        // Cargar datos al iniciar
        window.onload = refreshData;
    </script>

    <!-- Modal para ver resultados por maqueta -->
    <div id="maquetaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Resultados por Maqueta</h2>
                <button class="close-modal" onclick="cerrarModalMaqueta()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="maqueta-selector">
                    <label for="maquetaSelect" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Selecciona una Maqueta:
                    </label>
                    <select id="maquetaSelect" onchange="filtrarPorMaqueta()">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div id="maquetaResultados">
                    <div class="no-data">Selecciona una maqueta para ver los resultados</div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>